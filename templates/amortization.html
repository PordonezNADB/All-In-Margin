<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amortization Profile | NADB Calculator</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <style>
    :root {
      --nadb-blue:    #003F87;
      --nadb-mid:     #0066CC;
      --nadb-light:   #E8F0FA;
      --nadb-green:   #198754;
      --nadb-warn:    #dc3545;
      --panel-bg:     #f8f9fc;
      --border-color: #d0d7e2;
    }

    body {
      background: #eef1f6;
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 0.88rem;
      color: #222;
    }

    /* ── Navbar ── */
    .navbar-nadb {
      background: var(--nadb-blue);
      padding: 0.55rem 1.5rem;
    }
    .navbar-nadb .brand-text {
      color: #fff;
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .navbar-nadb .brand-sub {
      color: rgba(255,255,255,0.65);
      font-size: 0.77rem;
      margin-left: 1rem;
    }

    /* ── Layout ── */
    .main-row {
      min-height: calc(100vh - 56px);
    }
    .left-panel {
      background: #fff;
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      max-height: calc(100vh - 56px);
      position: sticky;
      top: 56px;
    }
    .right-panel {
      background: var(--panel-bg);
      overflow-y: auto;
      padding: 1.5rem;
    }

    /* ── Step indicator ── */
    .step-bar {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.78rem;
      font-weight: 600;
      color: #aaa;
    }
    .step-item.active  { color: var(--nadb-blue); }
    .step-item.done    { color: var(--nadb-green); }
    .step-num {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ddd;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step-item.active .step-num { background: var(--nadb-blue); color: #fff; }
    .step-item.done   .step-num { background: var(--nadb-green); color: #fff; }
    .step-connector { flex: 1; height: 2px; background: #ddd; margin: 0 0.6rem; }

    /* ── Loan summary card ── */
    .loan-summary {
      background: var(--nadb-light);
      border: 1px solid #b8caed;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }
    .loan-summary .sum-label {
      font-size: 0.69rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #5a7aaa;
      margin-bottom: 0.1rem;
    }
    .loan-summary .sum-value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--nadb-blue);
    }

    /* ── Section headers ── */
    .section-header {
      background: var(--nadb-light);
      border-left: 4px solid var(--nadb-blue);
      padding: 0.4rem 0.75rem;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--nadb-blue);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.75rem;
    }

    /* ── Form elements ── */
    .form-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #444;
      margin-bottom: 0.25rem;
    }
    .form-control, .form-select {
      font-size: 0.83rem;
      border-color: var(--border-color);
      padding: 0.35rem 0.55rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--nadb-mid);
      box-shadow: 0 0 0 0.18rem rgba(0,102,204,0.18);
    }
    .input-group-text {
      font-size: 0.8rem;
      background: var(--nadb-light);
      border-color: var(--border-color);
      color: var(--nadb-blue);
      font-weight: 600;
    }
    .form-text {
      font-size: 0.73rem;
      color: #777;
    }

    /* ── Profile toggle (3 options) ── */
    .profile-toggle .btn {
      font-size: 0.8rem;
      padding: 0.35rem 0.75rem;
    }
    .profile-toggle .btn-check:checked + .btn-outline-primary {
      background: var(--nadb-blue);
      border-color: var(--nadb-blue);
      color: #fff;
    }

    /* ── Bullet info box ── */
    .bullet-info {
      background: #f0faf4;
      border: 1px solid #a3d9b8;
      border-radius: 6px;
      padding: 1rem 1.2rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .bullet-info .bi {
      font-size: 1.4rem;
      color: var(--nadb-green);
      flex-shrink: 0;
    }

    /* ── Ad-hoc table ── */
    #adhocSection {
      background: #f0f5ff;
      border: 1px solid #b8caed;
      border-radius: 6px;
      padding: 0.85rem;
      margin-top: 0.5rem;
    }
    #adhocSection .table {
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }
    #adhocSection .table th {
      background: var(--nadb-blue);
      color: #fff;
      font-weight: 500;
      padding: 0.35rem 0.5rem;
    }
    #adhocSection .table td {
      padding: 0.25rem 0.4rem;
      vertical-align: middle;
    }
    #adhocSection .table td input {
      font-size: 0.8rem;
      padding: 0.2rem 0.35rem;
    }
    .btn-row-del {
      color: var(--nadb-warn);
      background: none;
      border: none;
      padding: 0.1rem 0.3rem;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-row-del:hover { color: #a00; }

    /* ── Mortgage section ── */
    #mortgageSection {
      background: #fff8f0;
      border: 1px solid #f0c070;
      border-radius: 6px;
      padding: 0.85rem;
      margin-top: 0.5rem;
    }

    /* ── Action buttons ── */
    .btn-calculate {
      background: var(--nadb-blue);
      border-color: var(--nadb-blue);
      color: #fff;
      font-weight: 600;
      padding: 0.5rem 1.4rem;
      font-size: 0.88rem;
      letter-spacing: 0.02em;
      transition: background 0.15s;
    }
    .btn-calculate:hover {
      background: #002d63;
      border-color: #002d63;
      color: #fff;
    }
    .btn-back {
      font-size: 0.83rem;
      color: #555;
      border-color: #bbb;
    }
    .btn-back:hover { background: #f0f0f0; }

    /* ── Summary cards ── */
    .result-card {
      border-radius: 8px;
      padding: 1.1rem 1.4rem;
      background: #fff;
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .result-card .card-label {
      font-size: 0.73rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #777;
      margin-bottom: 0.3rem;
    }
    .result-card .card-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--nadb-blue);
      line-height: 1.15;
    }
    .result-card .card-sub {
      font-size: 0.76rem;
      color: #888;
      margin-top: 0.15rem;
    }
    .badge-ok   { background: #d1f0e0; color: #0a5c3a; }
    .badge-warn { background: #ffe5e5; color: #8b0000; }
    .badge-status {
      font-size: 0.78rem;
      font-weight: 600;
      padding: 0.3rem 0.7rem;
      border-radius: 20px;
      display: inline-block;
    }

    /* ── IRR breakdown table ── */
    .irr-breakdown {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .irr-breakdown table { margin: 0; font-size: 0.83rem; }
    .irr-breakdown thead th {
      background: var(--nadb-blue);
      color: #fff;
      font-weight: 500;
      padding: 0.45rem 0.85rem;
    }
    .irr-breakdown tbody td { padding: 0.4rem 0.85rem; }
    .irr-breakdown .row-total {
      font-weight: 700;
      background: var(--nadb-light);
      border-top: 2px solid var(--nadb-blue);
    }
    .irr-breakdown .row-total td { color: var(--nadb-blue); }

    /* ── Schedule table ── */
    .schedule-wrapper {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .schedule-wrapper .table { font-size: 0.78rem; margin: 0; }
    .schedule-wrapper thead th {
      background: var(--nadb-blue);
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
      padding: 0.4rem 0.6rem;
      position: sticky;
      top: 0;
    }
    .schedule-wrapper tbody td {
      padding: 0.3rem 0.6rem;
      white-space: nowrap;
      vertical-align: middle;
    }
    .schedule-wrapper tbody tr:hover { background: #f0f5ff; }
    .row-draw  { background: #fffbe6 !important; }
    .row-amort { background: #f0faf4 !important; }
    .text-num  { text-align: right; font-family: 'Courier New', monospace; }
    .cell-zero { color: #bbb; }

    /* ── Export button ── */
    .btn-export {
      font-size: 0.83rem;
      color: var(--nadb-blue);
      border-color: var(--nadb-blue);
    }
    .btn-export:hover { background: var(--nadb-blue); color: #fff; }

    /* ── Loading spinner ── */
    #loadingOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.65);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #loadingOverlay.show { display: flex; }

    /* ── Error / placeholder ── */
    #errorBox  { display: none; }
    #placeholderBox {
      text-align: center;
      padding: 5rem 2rem;
      color: #aaa;
    }
    #placeholderBox .bi { font-size: 3rem; margin-bottom: 1rem; color: #ccc; }
    #resultsBox { display: none; }

    /* ── Responsive ── */
    @media (max-width: 991px) {
      .left-panel { position: static; max-height: none; border-right: none; border-bottom: 1px solid var(--border-color); }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-nadb">
    <div class="container-fluid">
      <span class="brand-text">
        <i class="bi bi-calculator-fill me-2"></i>All-In Margin Calculator
      </span>
      <span class="brand-sub">NADB Infrastructure Finance</span>
    </div>
  </nav>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary mb-2" role="status"></div>
      <div class="text-muted small">Calculating…</div>
    </div>
  </div>

  <!-- Inject loan params for JS -->
  <script>
    const LOAN_PARAMS = {{ loan_params | tojson }};
  </script>

  <!-- Main layout -->
  <div class="container-fluid px-0">
    <div class="row g-0 main-row">

      <!-- ═══════════════ LEFT: Amortization Config ═══════════════ -->
      <div class="col-lg-4 left-panel px-3 py-3">

        <!-- Step indicator -->
        <div class="step-bar mb-3">
          <div class="step-item done">
            <div class="step-num"><i class="bi bi-check-lg" style="font-size:0.65rem"></i></div>
            Loan Parameters
          </div>
          <div class="step-connector"></div>
          <div class="step-item active">
            <div class="step-num">2</div>
            Amortization Profile
          </div>
        </div>

        <!-- Loan params summary -->
        <div class="loan-summary mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="row g-2 flex-grow-1">
              <div class="col-6">
                <div class="sum-label">Amount</div>
                <div class="sum-value" id="sumAmount">—</div>
              </div>
              <div class="col-3">
                <div class="sum-label">Term</div>
                <div class="sum-value" id="sumTerm">—</div>
              </div>
              <div class="col-3">
                <div class="sum-label">Frequency</div>
                <div class="sum-value" id="sumFreq">—</div>
              </div>
              <div class="col-4">
                <div class="sum-label">Margin (draw)</div>
                <div class="sum-value" id="sumMarginDraw">—</div>
              </div>
              <div class="col-4">
                <div class="sum-label">Margin (after)</div>
                <div class="sum-value" id="sumMarginAfter">—</div>
              </div>
              <div class="col-4">
                <div class="sum-label">Disburse Date</div>
                <div class="sum-value" id="sumDate">—</div>
              </div>
            </div>
            <a href="/" class="btn btn-sm btn-outline-secondary ms-2 flex-shrink-0" style="font-size:0.75rem">
              <i class="bi bi-pencil me-1"></i>Edit
            </a>
          </div>
        </div>

        <!-- Profile type selector -->
        <div class="section-header mb-2">Amortization Profile</div>
        <div class="profile-toggle btn-group mb-2 w-100" role="group">
          <input type="radio" class="btn-check" name="amortProfile" id="profileBullet"   value="Bullet" />
          <label class="btn btn-outline-primary" for="profileBullet" style="width:33.33%">
            <i class="bi bi-arrow-right-circle me-1"></i>Bullet
          </label>
          <input type="radio" class="btn-check" name="amortProfile" id="profileAdhoc"   value="Ad-hoc" checked />
          <label class="btn btn-outline-primary" for="profileAdhoc" style="width:33.33%">
            <i class="bi bi-table me-1"></i>Ad-hoc
          </label>
          <input type="radio" class="btn-check" name="amortProfile" id="profileMortgage" value="Mortgage" />
          <label class="btn btn-outline-primary" for="profileMortgage" style="width:33.33%">
            <i class="bi bi-house me-1"></i>Mortgage
          </label>
        </div>

        <!-- ── Bullet section ── -->
        <div id="bulletSection" style="display:none">
          <div class="bullet-info">
            <i class="bi bi-check-circle-fill"></i>
            <div>
              <div class="fw-semibold mb-1" style="color: var(--nadb-green);">Full repayment at end</div>
              <div class="text-muted" style="font-size:0.8rem;">
                No principal is repaid until the final period, when the entire outstanding
                balance is repaid in a single bullet payment.
              </div>
            </div>
          </div>
        </div>

        <!-- ── Ad-hoc section ── -->
        <div id="adhocSection">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <strong style="font-size:0.8rem; color: var(--nadb-blue);">
              <i class="bi bi-table me-1"></i>Amortization Schedule
            </strong>
            <div class="d-flex gap-2 align-items-center">
              <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="radio" name="adhocType" id="typePercent" value="percent" checked />
                <label class="form-check-label" for="typePercent" style="font-size:0.77rem">% of loan</label>
              </div>
              <div class="form-check form-check-inline mb-0">
                <input class="form-check-input" type="radio" name="adhocType" id="typeDollar" value="dollar" />
                <label class="form-check-label" for="typeDollar" style="font-size:0.77rem">$ amount</label>
              </div>
            </div>
          </div>

          <div style="max-height:280px; overflow-y:auto;">
            <table class="table table-sm table-bordered" id="adhocTable">
              <thead>
                <tr>
                  <th>Month Offset</th>
                  <th id="adhocValueHeader">Value (%)</th>
                  <th style="width:32px"></th>
                </tr>
              </thead>
              <tbody id="adhocBody">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>

          <div class="d-flex gap-2 mt-1">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addAdhocRow()">
              <i class="bi bi-plus-circle me-1"></i>Add Row
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadLaGrulla()">
              <i class="bi bi-file-earmark-arrow-down me-1"></i>Load La Grulla
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearAdhoc()">
              <i class="bi bi-trash me-1"></i>Clear
            </button>
          </div>
        </div><!-- /adhocSection -->

        <!-- ── Mortgage section ── -->
        <div id="mortgageSection" style="display:none">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Mortgage Rate (annual)</label>
              <div class="input-group">
                <input type="number" id="mortgageRate" class="form-control"
                       value="5.0" step="0.01" min="0" />
                <span class="input-group-text">%</span>
              </div>
              <div class="form-text">Rate used for PMT calculation</div>
            </div>
            <div class="col-6">
              <label class="form-label">Amortization Period</label>
              <div class="input-group">
                <input type="number" id="mortgageAmortYears" class="form-control"
                       value="30" step="1" min="1" />
                <span class="input-group-text">yrs</span>
              </div>
              <div class="form-text">Can exceed loan term</div>
            </div>
          </div>
          <div class="mt-2 text-muted" style="font-size:0.78rem;">
            <i class="bi bi-info-circle me-1"></i>
            Generates a fixed-payment (level-pay) schedule. On the final period, any
            remaining balance is fully repaid.
          </div>
        </div><!-- /mortgageSection -->

        <!-- Action buttons -->
        <div class="d-flex gap-2 mt-3 pt-2 border-top">
          <a href="/" class="btn btn-outline-secondary btn-back">
            <i class="bi bi-arrow-left me-1"></i>Back
          </a>
          <button type="button" class="btn btn-calculate flex-grow-1" onclick="runCalculate()">
            <i class="bi bi-play-fill me-1"></i>Calculate
          </button>
        </div>

      </div><!-- /left-panel -->

      <!-- ═══════════════ RIGHT: Results ═══════════════ -->
      <div class="col-lg-8 right-panel">

        <!-- Error box -->
        <div id="errorBox" class="alert alert-danger alert-dismissible d-flex align-items-start gap-2 mb-3">
          <i class="bi bi-exclamation-triangle-fill mt-1"></i>
          <div>
            <strong>Calculation Error</strong>
            <div id="errorMsg" class="small mt-1"></div>
          </div>
          <button type="button" class="btn-close ms-auto" onclick="hideError()"></button>
        </div>

        <!-- Placeholder -->
        <div id="placeholderBox">
          <i class="bi bi-calculator"></i>
          <p class="fw-semibold" style="color:#999">Choose a profile type and click Calculate</p>
          <p class="small text-muted">IRR components, WAL, and full amortization schedule will appear here.</p>
        </div>

        <!-- Results -->
        <div id="resultsBox">

          <!-- Summary Cards -->
          <div class="row g-3 mb-3">
            <div class="col-sm-4">
              <div class="result-card h-100">
                <div class="card-label"><i class="bi bi-percent me-1"></i>All-In Margin (IRR)</div>
                <div class="card-value" id="resAllIn">—</div>
                <div class="card-sub">Annualized effective rate</div>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="result-card h-100">
                <div class="card-label"><i class="bi bi-clock me-1"></i>Weighted Avg Life</div>
                <div class="card-value" id="resWAL" style="color:#0a5c3a">—</div>
                <div class="card-sub">Years to full repayment</div>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="result-card h-100">
                <div class="card-label"><i class="bi bi-check2-circle me-1"></i>Validation</div>
                <div class="mt-1" id="resValidation">
                  <span class="badge-status badge-ok">—</span>
                </div>
                <div class="card-sub mt-1" id="resValidationDetail"></div>
              </div>
            </div>
          </div>

          <!-- IRR Component Breakdown -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 fw-semibold" style="color: var(--nadb-blue);">
                <i class="bi bi-pie-chart me-1"></i>All-In Margin Components
              </h6>
            </div>
            <div class="irr-breakdown">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Component</th>
                    <th class="text-end">Contribution</th>
                    <th class="text-end">Cumulative</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody id="irrBreakdown">
                  <tr><td colspan="4" class="text-muted text-center py-2">—</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Amortization Schedule -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 fw-semibold" style="color: var(--nadb-blue);">
                <i class="bi bi-table me-1"></i>Amortization Schedule
              </h6>
              <button class="btn btn-sm btn-export" onclick="exportCSV()">
                <i class="bi bi-download me-1"></i>Export CSV
              </button>
            </div>

            <div class="schedule-wrapper" style="max-height:480px; overflow-y:auto;">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Period</th>
                    <th>Date</th>
                    <th class="text-end">Days</th>
                    <th class="text-end">Beg. Balance</th>
                    <th class="text-end">Draws</th>
                    <th class="text-end">Amortization</th>
                    <th class="text-end">Interest</th>
                    <th class="text-end">Upfront Fee</th>
                    <th class="text-end">Commit. Fee</th>
                    <th class="text-end">End. Balance</th>
                  </tr>
                </thead>
                <tbody id="scheduleBody">
                  <tr><td colspan="10" class="text-muted text-center py-3">—</td></tr>
                </tbody>
              </table>
            </div>
            <div class="text-muted small mt-1" id="scheduleFooter"></div>
          </div>

        </div><!-- /resultsBox -->
      </div><!-- /right-panel -->
    </div><!-- /row -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // ─────────────────────────────────────────────
  // Populate loan params summary from session data
  // ─────────────────────────────────────────────
  (function populateSummary() {
    const p = LOAN_PARAMS;
    const fmtNum = v => Number(v).toLocaleString('en-US', {maximumFractionDigits: 0});
    const fmtPct = v => (v * 100).toFixed(3) + '%';
    const freqShort = {'Monthly':'Mo','Quarterly':'Qtr','Semiannually':'Semi'}[p.frequency] || p.frequency;
    document.getElementById('sumAmount').textContent     = '$' + fmtNum(p.loan_amount);
    document.getElementById('sumTerm').textContent       = (p.loan_term || '') + ' yrs';
    document.getElementById('sumFreq').textContent       = freqShort;
    document.getElementById('sumMarginDraw').textContent  = fmtPct(p.margin_draw);
    document.getElementById('sumMarginAfter').textContent = fmtPct(p.margin_after);
    document.getElementById('sumDate').textContent       = p.disbursement_date || '—';
  })();

  // ─────────────────────────────────────────────
  // La Grulla default ad-hoc schedule
  // ─────────────────────────────────────────────
  const LA_GRULLA_ADHOC = [
    {month:0,   value:0},
    {month:33,  value:1},
    {month:45,  value:2},
    {month:57,  value:3},
    {month:69,  value:4},
    {month:81,  value:5},
    {month:93,  value:6},
    {month:105, value:7},
    {month:117, value:8},
    {month:129, value:9},
    {month:141, value:10},
    {month:153, value:11},
    {month:165, value:12},
    {month:177, value:13},
    {month:189, value:14},
    {month:201, value:15},
    {month:213, value:16},
    {month:225, value:17},
    {month:237, value:18},
    {month:249, value:19},
    {month:261, value:20},
    {month:273, value:21},
    {month:285, value:22},
    {month:297, value:23},
  ];

  // ─────────────────────────────────────────────
  // Profile section visibility
  // ─────────────────────────────────────────────
  function updateProfileSections() {
    const profile = document.querySelector('input[name="amortProfile"]:checked').value;
    document.getElementById('bulletSection').style.display   = profile === 'Bullet'   ? 'block' : 'none';
    document.getElementById('adhocSection').style.display    = profile === 'Ad-hoc'   ? 'block' : 'none';
    document.getElementById('mortgageSection').style.display = profile === 'Mortgage' ? 'block' : 'none';
  }

  document.querySelectorAll('input[name="amortProfile"]').forEach(r => {
    r.addEventListener('change', updateProfileSections);
  });

  // Update adhoc value column header on type switch
  document.querySelectorAll('input[name="adhocType"]').forEach(r => {
    r.addEventListener('change', () => {
      const isPct = document.getElementById('typePercent').checked;
      document.getElementById('adhocValueHeader').textContent = isPct ? 'Value (%)' : 'Value ($)';
    });
  });

  // ─────────────────────────────────────────────
  // Ad-hoc table management
  // ─────────────────────────────────────────────
  function renderAdhocTable(data) {
    const tbody = document.getElementById('adhocBody');
    tbody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" class="form-control form-control-sm adhoc-month"
             value="${row.month}" min="0" /></td>
        <td><input type="number" class="form-control form-control-sm adhoc-value"
             value="${row.value}" min="0" step="0.001" /></td>
        <td>
          <button type="button" class="btn-row-del" onclick="deleteAdhocRow(this)">
            <i class="bi bi-x-circle"></i>
          </button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function getAdhocData() {
    return Array.from(document.querySelectorAll('#adhocBody tr')).map(tr => ({
      month: parseFloat(tr.querySelector('.adhoc-month').value) || 0,
      value: parseFloat(tr.querySelector('.adhoc-value').value) || 0,
    })).sort((a, b) => a.month - b.month);
  }

  function addAdhocRow() {
    const data = getAdhocData();
    data.push({month: 0, value: 0});
    renderAdhocTable(data);
    const rows = document.querySelectorAll('#adhocBody tr');
    if (rows.length) rows[rows.length - 1].querySelector('.adhoc-month').focus();
  }

  function deleteAdhocRow(btn) { btn.closest('tr').remove(); }
  function clearAdhoc()        { renderAdhocTable([]); }
  function loadLaGrulla()      { renderAdhocTable(LA_GRULLA_ADHOC); }

  // ─────────────────────────────────────────────
  // Formatting helpers
  // ─────────────────────────────────────────────
  const fmt = {
    currency: v => v === 0
      ? '<span class="cell-zero">—</span>'
      : '$' + v.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
    pct: v => v.toFixed(4) + '%',
    num: v => v === 0 ? '<span class="cell-zero">—</span>' : v.toLocaleString(),
  };

  // ─────────────────────────────────────────────
  // Calculate
  // ─────────────────────────────────────────────
  async function runCalculate() {
    hideError();

    const profile    = document.querySelector('input[name="amortProfile"]:checked').value;
    const usePercent = document.getElementById('typePercent').checked;

    // Mortgage validation
    if (profile === 'Mortgage') {
      const rate  = parseFloat(document.getElementById('mortgageRate').value);
      const years = parseFloat(document.getElementById('mortgageAmortYears').value);
      if (isNaN(rate) || rate < 0)   { showError('Mortgage rate must be non-negative'); return; }
      if (isNaN(years) || years <= 0) { showError('Amortization period must be greater than 0'); return; }
    }

    showLoading(true);

    const amortPayload = {
      amortization_profile: profile,
      adhoc_table:          profile === 'Ad-hoc'   ? getAdhocData() : [],
      adhoc_use_percent:    usePercent,
      mortgage_rate:        profile === 'Mortgage'  ? parseFloat(document.getElementById('mortgageRate').value) / 100 : 0,
      mortgage_amort_years: profile === 'Mortgage'  ? parseFloat(document.getElementById('mortgageAmortYears').value) : 0,
    };

    try {
      const res  = await fetch('/calculate', {
        method:  'POST',
        headers: {'Content-Type': 'application/json'},
        body:    JSON.stringify(amortPayload),
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Unknown error');
      renderResults(data, amortPayload);
    } catch (err) {
      showError(err.message);
    } finally {
      showLoading(false);
    }
  }

  // ─────────────────────────────────────────────
  // Render results
  // ─────────────────────────────────────────────
  function renderResults(data, amortPayload) {
    document.getElementById('placeholderBox').style.display = 'none';
    document.getElementById('resultsBox').style.display     = 'block';

    // Summary cards
    document.getElementById('resAllIn').textContent = data.irr.all_in_margin.toFixed(4) + '%';
    document.getElementById('resWAL').textContent   = data.wal.toFixed(3) + ' yrs';

    const vld  = data.validation;
    const isOk = vld.draw_status === 'OK';
    document.getElementById('resValidation').innerHTML =
      `<span class="badge-status ${isOk ? 'badge-ok' : 'badge-warn'}">${vld.draw_status}</span>`;
    document.getElementById('resValidationDetail').innerHTML =
      `Draws: $${vld.draws_total.toLocaleString('en-US', {minimumFractionDigits: 0})} &nbsp;|&nbsp; ` +
      `Amort: $${vld.amort_total.toLocaleString('en-US', {minimumFractionDigits: 0})} &nbsp;|&nbsp; ` +
      `Final Bal: $${vld.final_balance.toLocaleString('en-US', {minimumFractionDigits: 0})}`;

    // IRR breakdown
    const irr        = data.irr;
    const cumSpread  = irr.ir_spread;
    const cumUpfront = cumSpread + irr.upfront_impact;
    const cumAllIn   = irr.all_in_margin;
    document.getElementById('irrBreakdown').innerHTML = `
      <tr>
        <td><i class="bi bi-plus-circle text-primary me-1"></i>IR Spread</td>
        <td class="text-end text-num">${fmt.pct(irr.ir_spread)}</td>
        <td class="text-end text-num">${fmt.pct(cumSpread)}</td>
        <td class="text-muted small">Base interest rate margin</td>
      </tr>
      <tr>
        <td><i class="bi bi-plus-circle text-warning me-1"></i>Upfront Fee Impact</td>
        <td class="text-end text-num">${fmt.pct(irr.upfront_impact)}</td>
        <td class="text-end text-num">${fmt.pct(cumUpfront)}</td>
        <td class="text-muted small">One-time fee, spread over WAL</td>
      </tr>
      <tr>
        <td><i class="bi bi-plus-circle text-success me-1"></i>Commitment Fee Impact</td>
        <td class="text-end text-num">${fmt.pct(irr.commitment_impact)}</td>
        <td class="text-end text-num">${fmt.pct(cumAllIn)}</td>
        <td class="text-muted small">Fee on undrawn balance</td>
      </tr>
      <tr class="row-total">
        <td><strong>= All-In Margin (IRR)</strong></td>
        <td class="text-end text-num"><strong>${fmt.pct(irr.all_in_margin)}</strong></td>
        <td class="text-end text-num"><strong>${fmt.pct(irr.all_in_margin)}</strong></td>
        <td class="text-muted small">Annualized effective rate</td>
      </tr>`;

    // Schedule table
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';
    data.schedule.forEach(row => {
      const isDraw  = row.draws > 0;
      const isAmort = row.amortization > 0;
      const tr = document.createElement('tr');
      if (isDraw)  tr.classList.add('row-draw');
      if (isAmort) tr.classList.add('row-amort');
      tr.innerHTML = `
        <td>${row.period}</td>
        <td>${row.date}</td>
        <td class="text-end">${row.days || '—'}</td>
        <td class="text-end text-num">${row.beginning_bal > 0 ? '$' + row.beginning_bal.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num">${row.draws > 0 ? '$' + row.draws.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num">${row.amortization > 0 ? '$' + row.amortization.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num">${row.interest > 0 ? '$' + row.interest.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num">${row.upfront_fee > 0 ? '$' + row.upfront_fee.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num">${row.commitment_fee > 0 ? '$' + row.commitment_fee.toLocaleString('en-US', {minimumFractionDigits: 2}) : '<span class="cell-zero">—</span>'}</td>
        <td class="text-end text-num"><strong>$${row.ending_bal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('scheduleFooter').textContent =
      `${data.schedule.length} periods  ·  ` +
      `${LOAN_PARAMS.frequency}  ·  ` +
      `Profile: ${amortPayload.amortization_profile}`;

    // Store merged payload for CSV export
    window._lastAmortPayload = amortPayload;
  }

  // ─────────────────────────────────────────────
  // CSV Export
  // ─────────────────────────────────────────────
  async function exportCSV() {
    if (!window._lastAmortPayload) return;
    try {
      const res  = await fetch('/export/csv', {
        method:  'POST',
        headers: {'Content-Type': 'application/json'},
        body:    JSON.stringify(window._lastAmortPayload),
      });
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'amortization_schedule.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch (e) {
      showError('Export failed: ' + e.message);
    }
  }

  // ─────────────────────────────────────────────
  // UI helpers
  // ─────────────────────────────────────────────
  function showLoading(on) {
    document.getElementById('loadingOverlay').classList.toggle('show', on);
  }
  function showError(msg) {
    const el = document.getElementById('errorMsg');
    if (msg.includes('<')) { el.innerHTML = msg; } else { el.textContent = msg; }
    document.getElementById('errorBox').style.display = 'flex';
  }
  function hideError() {
    document.getElementById('errorBox').style.display = 'none';
  }

  // ─────────────────────────────────────────────
  // Init
  // ─────────────────────────────────────────────
  updateProfileSections();
  loadLaGrulla();
  </script>
</body>
</html>
