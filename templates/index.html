<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All-In Margin Calculator | NADB</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

  <style>
    :root {
      --nadb-blue:    #003F87;
      --nadb-mid:     #0066CC;
      --nadb-light:   #E8F0FA;
      --nadb-green:   #198754;
      --nadb-warn:    #dc3545;
      --border-color: #d0d7e2;
    }

    body {
      background: #eef1f6;
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 0.88rem;
      color: #222;
    }

    /* ── Navbar ── */
    .navbar-nadb {
      background: var(--nadb-blue);
      padding: 0.55rem 1.5rem;
    }
    .navbar-nadb .brand-text {
      color: #fff;
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .navbar-nadb .brand-sub {
      color: rgba(255,255,255,0.65);
      font-size: 0.77rem;
      margin-left: 1rem;
    }

    /* ── Step indicator ── */
    .step-bar {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 1.75rem;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.82rem;
      font-weight: 600;
      color: #aaa;
    }
    .step-item.active {
      color: var(--nadb-blue);
    }
    .step-item.active .step-num {
      background: var(--nadb-blue);
      color: #fff;
    }
    .step-num {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #ddd;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step-connector {
      flex: 1;
      height: 2px;
      background: #ddd;
      margin: 0 0.75rem;
    }

    /* ── Form card ── */
    .form-card {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    /* ── Section headers ── */
    .section-header {
      background: var(--nadb-light);
      border-left: 4px solid var(--nadb-blue);
      padding: 0.4rem 0.75rem;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--nadb-blue);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.75rem;
      border-radius: 0 4px 4px 0;
    }

    /* ── Form elements ── */
    .form-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #444;
      margin-bottom: 0.25rem;
    }
    .form-control, .form-select {
      font-size: 0.83rem;
      border-color: var(--border-color);
      padding: 0.35rem 0.55rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--nadb-mid);
      box-shadow: 0 0 0 0.18rem rgba(0,102,204,0.18);
    }
    .input-group-text {
      font-size: 0.8rem;
      background: var(--nadb-light);
      border-color: var(--border-color);
      color: var(--nadb-blue);
      font-weight: 600;
    }
    .form-text {
      font-size: 0.73rem;
      color: #777;
    }

    /* ── Buttons ── */
    .btn-next {
      background: var(--nadb-blue);
      border-color: var(--nadb-blue);
      color: #fff;
      font-weight: 600;
      padding: 0.55rem 1.75rem;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      transition: background 0.15s;
    }
    .btn-next:hover {
      background: #002d63;
      border-color: #002d63;
      color: #fff;
    }
    .btn-reset {
      font-size: 0.83rem;
      color: #666;
    }

    /* ── Loading spinner ── */
    #loadingOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.65);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #loadingOverlay.show { display: flex; }

    /* ── Error alert ── */
    #errorBox { display: none; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-nadb">
    <div class="container-fluid">
      <span class="brand-text">
        <i class="bi bi-calculator-fill me-2"></i>All-In Margin Calculator
      </span>
      <span class="brand-sub">NADB Infrastructure Finance</span>
    </div>
  </nav>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary mb-2" role="status"></div>
      <div class="text-muted small">Saving parameters…</div>
    </div>
  </div>

  <!-- Main content -->
  <div class="container py-4" style="max-width: 620px;">

    <!-- Step indicator -->
    <div class="step-bar">
      <div class="step-item active">
        <div class="step-num">1</div>
        Loan Parameters
      </div>
      <div class="step-connector"></div>
      <div class="step-item">
        <div class="step-num">2</div>
        Amortization Profile
      </div>
    </div>

    <!-- Error box -->
    <div id="errorBox" class="alert alert-danger alert-dismissible d-flex align-items-start gap-2 mb-3">
      <i class="bi bi-exclamation-triangle-fill mt-1"></i>
      <div>
        <strong>Please fix the following:</strong>
        <div id="errorMsg" class="small mt-1"></div>
      </div>
      <button type="button" class="btn-close ms-auto" onclick="hideError()"></button>
    </div>

    <!-- Form card -->
    <div class="form-card">
      <form id="calcForm" novalidate>

        <!-- 1. Loan Parameters -->
        <div class="section-header mb-2">Loan Parameters</div>
        <div class="row g-2 mb-2">
          <div class="col-7">
            <label class="form-label">NADB Amount (USD)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="loanAmount" class="form-control"
                     value="{{ loan_params.get('loan_amount', 1300000) | int }}"
                     min="0" step="1000" required />
            </div>
          </div>
          <div class="col-5">
            <label class="form-label">Loan Term (Years)</label>
            <input type="number" id="loanTerm" class="form-control"
                   value="{{ loan_params.get('loan_term', 25) }}"
                   min="0.25" step="0.25" required />
            <div class="form-text">Auto-calculates periods</div>
          </div>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">Draw Period</label>
            <input type="number" id="drawPeriod" class="form-control"
                   value="{{ loan_params.get('draw_period', 1) }}" min="0" />
            <div class="form-text">Periods when draws occur</div>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Frequency</label>
            <select id="frequency" class="form-select">
              <option value="Monthly" {{ 'selected' if loan_params.get('frequency') == 'Monthly' else '' }}>Monthly</option>
              <option value="Quarterly" {{ 'selected' if loan_params.get('frequency') == 'Quarterly' else '' }}>Quarterly</option>
              <option value="Semiannually" {{ 'selected' if loan_params.get('frequency', 'Semiannually') == 'Semiannually' else '' }}>Semiannually</option>
            </select>
          </div>
        </div>

        <!-- 2. Interest Rates -->
        <div class="section-header mb-2">Interest Rates & Margins</div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">Margin – Draw Period</label>
            <div class="input-group">
              <input type="number" id="marginDraw" class="form-control"
                     value="{{ (loan_params.get('margin_draw', 0.0158) * 100) | round(3) }}"
                     step="0.001" min="0" />
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">Margin – After Draw</label>
            <div class="input-group">
              <input type="number" id="marginAfter" class="form-control"
                     value="{{ (loan_params.get('margin_after', 0.0158) * 100) | round(3) }}"
                     step="0.001" min="0" />
              <span class="input-group-text">%</span>
            </div>
          </div>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">Step-Up Rate <span class="text-muted">(opt.)</span></label>
            <div class="input-group">
              <input type="number" id="stepUp" class="form-control"
                     value="{{ (loan_params.get('step_up', 0) * 100) | round(3) }}"
                     step="0.001" min="0" />
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">Step-Up Period <span class="text-muted">(opt.)</span></label>
            <input type="number" id="stepUpPeriod" class="form-control"
                   value="{{ loan_params.get('step_up_period', 0) }}" min="0" />
            <div class="form-text">0 = no step-up</div>
          </div>
        </div>

        <!-- 3. Fees -->
        <div class="section-header mb-2">Fees</div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">Upfront Fee</label>
            <div class="input-group">
              <input type="number" id="upfrontFee" class="form-control"
                     value="{{ (loan_params.get('upfront_fee_rate', 0) * 100) | round(3) }}"
                     step="0.01" min="0" />
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">Commitment Fee</label>
            <div class="input-group">
              <input type="number" id="commitmentFee" class="form-control"
                     value="{{ (loan_params.get('commitment_fee_rate', 0) * 100) | round(3) }}"
                     step="0.01" min="0" />
              <span class="input-group-text">%</span>
            </div>
            <div class="form-text">On undrawn balance</div>
          </div>
        </div>

        <!-- 4. Dates -->
        <div class="section-header mb-2">Dates</div>
        <div class="row g-2 mb-4">
          <div class="col-6">
            <label class="form-label">Closing Date</label>
            <input type="date" id="closingDate" class="form-control"
                   value="{{ loan_params.get('closing_date', '2026-04-01') }}" required />
          </div>
          <div class="col-6">
            <label class="form-label">1st Disbursement Date</label>
            <input type="date" id="disbursementDate" class="form-control"
                   value="{{ loan_params.get('disbursement_date', '2026-04-01') }}" required />
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2 pt-2 border-top">
          <button type="submit" class="btn btn-next flex-grow-1">
            Next: Configure Amortization&nbsp;<i class="bi bi-arrow-right ms-1"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-reset" onclick="resetForm()" title="Reset to defaults">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
        </div>

      </form>
    </div><!-- /form-card -->
  </div><!-- /container -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // ─────────────────────────────────────────────
  // Validation helper
  // ─────────────────────────────────────────────
  function validateForm() {
    const errors = [];

    const loanAmount = parseFloat(document.getElementById('loanAmount').value);
    if (isNaN(loanAmount) || loanAmount <= 0) {
      errors.push('Loan amount must be greater than 0');
    }

    const loanTerm = parseFloat(document.getElementById('loanTerm').value);
    if (isNaN(loanTerm) || loanTerm <= 0) {
      errors.push('Loan term must be greater than 0');
    }

    const drawPeriod = parseInt(document.getElementById('drawPeriod').value);
    const frequency  = document.getElementById('frequency').value;
    const freqMultiplier = {'Monthly': 12, 'Quarterly': 4, 'Semiannually': 2}[frequency];
    const numPeriods = Math.round(loanTerm * freqMultiplier);

    if (drawPeriod < 0) {
      errors.push('Draw period cannot be negative');
    }
    if (drawPeriod > numPeriods) {
      errors.push(`Draw period (${drawPeriod}) cannot exceed number of periods (${numPeriods})`);
    }

    const closingDate      = document.getElementById('closingDate').value;
    const disbursementDate = document.getElementById('disbursementDate').value;
    if (!closingDate)      errors.push('Closing date is required');
    if (!disbursementDate) errors.push('Disbursement date is required');

    const marginDraw  = parseFloat(document.getElementById('marginDraw').value);
    const marginAfter = parseFloat(document.getElementById('marginAfter').value);
    if (isNaN(marginDraw)  || marginDraw  < 0) errors.push('Margin (draw period) must be non-negative');
    if (isNaN(marginAfter) || marginAfter < 0) errors.push('Margin (after draw) must be non-negative');

    return errors;
  }

  // ─────────────────────────────────────────────
  // Form submission → save params, navigate to Screen 2
  // ─────────────────────────────────────────────
  document.getElementById('calcForm').addEventListener('submit', async e => {
    e.preventDefault();
    hideError();

    const errors = validateForm();
    if (errors.length > 0) {
      showError(errors.join('<br>'));
      return;
    }

    showLoading(true);

    const frequency      = document.getElementById('frequency').value;
    const loanTerm       = parseFloat(document.getElementById('loanTerm').value);
    const freqMultiplier = {'Monthly': 12, 'Quarterly': 4, 'Semiannually': 2}[frequency];
    const numPeriods     = Math.round(loanTerm * freqMultiplier);

    const payload = {
      loan_amount:          parseFloat(document.getElementById('loanAmount').value),
      loan_term:            loanTerm,
      num_periods:          numPeriods,
      draw_period:          parseInt(document.getElementById('drawPeriod').value),
      grace_periods:        numPeriods,
      frequency:            frequency,
      margin_draw:          parseFloat(document.getElementById('marginDraw').value) / 100,
      margin_after:         parseFloat(document.getElementById('marginAfter').value) / 100,
      step_up:              parseFloat(document.getElementById('stepUp').value) / 100,
      step_up_period:       parseInt(document.getElementById('stepUpPeriod').value),
      upfront_fee_rate:     parseFloat(document.getElementById('upfrontFee').value) / 100,
      commitment_fee_rate:  parseFloat(document.getElementById('commitmentFee').value) / 100,
      closing_date:         document.getElementById('closingDate').value,
      disbursement_date:    document.getElementById('disbursementDate').value,
    };

    try {
      const res  = await fetch('/save-params', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Failed to save parameters');
      window.location.href = '/amortization';
    } catch (err) {
      showError(err.message);
      showLoading(false);
    }
  });

  // ─────────────────────────────────────────────
  // UI helpers
  // ─────────────────────────────────────────────
  function showLoading(on) {
    document.getElementById('loadingOverlay').classList.toggle('show', on);
  }
  function showError(msg) {
    const el = document.getElementById('errorMsg');
    if (msg.includes('<')) { el.innerHTML = msg; } else { el.textContent = msg; }
    document.getElementById('errorBox').style.display = 'flex';
  }
  function hideError() {
    document.getElementById('errorBox').style.display = 'none';
  }

  function resetForm() {
    document.getElementById('loanAmount').value      = '1300000';
    document.getElementById('loanTerm').value        = '25';
    document.getElementById('drawPeriod').value      = '1';
    document.getElementById('frequency').value       = 'Semiannually';
    document.getElementById('marginDraw').value      = '1.58';
    document.getElementById('marginAfter').value     = '1.58';
    document.getElementById('stepUp').value          = '0';
    document.getElementById('stepUpPeriod').value    = '0';
    document.getElementById('upfrontFee').value      = '0';
    document.getElementById('commitmentFee').value   = '0';
    document.getElementById('closingDate').value     = '2026-04-01';
    document.getElementById('disbursementDate').value= '2026-04-01';
    hideError();
  }
  </script>
</body>
</html>
